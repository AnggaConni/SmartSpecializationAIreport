<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 Builder - Strategic Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: { 700: '#1e3a5f', 800: '#162e4d', 900: '#0f172a' },
                        terracotta: { 500: '#e07a5f', 600: '#c56b3e' },
                        sage: { 100: '#e6f4ea', 600: '#1e8e3e' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    }
                }
            }
        }

        // --- AI ENGINE ---
        const AI_BRIDGE = {
            models: ['gemini-2.5-flash', 'gemini-2.0-flash-exp'],
            hasKey: (key) => !!key && key.length > 10,
            async generate(prompt, apiKey, onProgress) {
                const cleanKey = apiKey ? apiKey.trim() : "";
                if (!this.hasKey(cleanKey)) throw new Error("API Key Invalid / Kosong");
                
                for (const model of this.models) {
                    try {
                        if (onProgress) onProgress(`Thinking (${model})...`);
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${cleanKey}`;
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        if (!response.ok) throw new Error("Gagal menghubungi Google AI. Cek Quota/Key.");
                        const data = await response.json();
                        return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    } catch (e) {
                        if (model === this.models[this.models.length-1]) throw e;
                    }
                }
            }
        };
    </script>

    <style>
        .report-paper { background: white; box-shadow: 0 0 15px rgba(0,0,0,0.05); min-height: 800px; }
        .accordion-content { transition: max-height 0.3s ease-in-out; overflow: hidden; }
        
        /* Print Styles */
        /* Print Styles - UPDATED */
        @media print { 
            /* 1. Sembunyikan elemen pengganggu */
            .no-print, button, input, textarea, select { display: none !important; } 
            
            /* 2. Reset Layout Halaman */
            body, html, #root { 
                background: white; 
                width: 100%; 
                height: 100%; 
                margin: 0; 
                padding: 0; 
                overflow: visible !important; /* PENTING: Matikan scroll */
            }

            /* 3. Atur Kertas Laporan agar Dominan */
            .report-paper { 
                box-shadow: none !important; 
                border: none !important; 
                width: 100% !important; 
                max-width: 100% !important; /* Paksa lebar penuh */
                padding: 0 !important; 
                margin: 0 !important;
                position: absolute;
                top: 0;
                left: 0;
            } 

            /* 4. Trik agar Diagram/Paragraf tidak terpotong di tengah halaman */
            .page-break-avoid { 
                page-break-inside: avoid !important; 
                break-inside: avoid !important;
                display: block; /* Kadang perlu ini agar browser patuh */
            }
            
            .page-break { page-break-before: always; }
        }

        /* Tooltip Enhanced */
        .tooltip-container { position: relative; display: inline-flex; align-items: center; margin-left: 6px; }
        .tooltip-icon { width: 16px; height: 16px; background: #cbd5e1; color: #475569; border-radius: 50%; font-size: 10px; font-weight: bold; cursor: help; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .tooltip-icon:hover { background: #1e3a5f; color: white; }
        .tooltip-text { visibility: hidden; width: 220px; background-color: #1e3a5f; color: #fff; text-align: left; border-radius: 6px; padding: 10px; position: absolute; z-index: 50; bottom: 140%; left: 50%; transform: translateX(-50%); opacity: 0; transition: all 0.2s; font-size: 11px; line-height: 1.4; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); pointer-events: none; }
        .tooltip-text::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #1e3a5f transparent transparent transparent; }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; bottom: 130%; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- HELP REGISTRY (EXPANDED) ---
        const HELP_REGISTRY = {
            // General
            regionName: "Identitas wilayah analisis (Provinsi/Kab/Kota).",
            vision: "Gambaran masa depan ekonomi yang ingin dicapai dalam 5-10 tahun.",
            timeline: "Periode pelaksanaan strategi (misal: 2025-2030).",
            // Sectors
            localVal: "Output/PDRB sektor ini di wilayah Anda (dalam Miliar Rupiah).",
            nationalVal: "Output sektor yang sama di tingkat Nasional (Benchmark untuk LQ).",
            workers: "Jumlah tenaga kerja yang terserap di sektor ini.",
            exportVal: "Nilai ekspor produk sektor ini ke luar wilayah/negeri.",
            rationale: "Alasan kualitatif mengapa sektor ini strategis (mis: budaya, SDA unik).",
            // SWOT
            strength: "Faktor internal positif (SDA melimpah, SDM terampil).",
            weakness: "Faktor internal negatif (Infrastruktur buruk, kurang modal).",
            opportunity: "Faktor eksternal positif (Tren pasar global, kebijakan pusat).",
            threat: "Faktor eksternal negatif (Bencana alam, persaingan harga).",
            // Helix
            helixName: "Nama Lembaga/Organisasi/Tokoh.",
            helixRole: "Peran dalam S3 (Pemerintah, Akademisi, Bisnis, Komunitas).",
            // Action
            actionActivity: "Program konkret yang akan dijalankan.",
            actionOutput: "Target terukur dari kegiatan tersebut.",
            actionBudget: "Estimasi biaya yang dibutuhkan."
        };

        const SECTOR_CONFIG = [
            { key: 'localVal', label: 'Local Output (USD Million)', type: 'number' }, // Ubah Label
            { key: 'nationalVal', label: 'National Output (USD Million)', type: 'number' }, // Ubah Label
            { key: 'workers', label: 'Labor Force (Jiwa)', type: 'number' },
            { key: 'exportVal', label: 'Export Value (USD Million)', type: 'number' } // Ubah Label
        ];

        // --- COMPONENTS ---

        const Accordion = ({ title, isOpen, onClick, children, extraAction, icon = 'üìÅ' }) => (
            <div className="border-b border-slate-200">
                <div className={`flex justify-between items-center p-4 cursor-pointer transition-colors ${isOpen ? 'bg-slate-50 border-l-4 border-navy-700' : 'bg-white hover:bg-slate-50'}`} onClick={onClick}>
                    <h3 className="font-bold text-navy-800 uppercase text-xs tracking-wider flex items-center gap-2">
                        <span>{icon}</span> {title}
                    </h3>
                    <div className="flex items-center gap-3">
                        {extraAction && <div onClick={e => e.stopPropagation()}>{extraAction}</div>}
                        <span className={`text-slate-400 text-xs transition-transform transform ${isOpen ? 'rotate-180' : ''}`}>‚ñº</span>
                    </div>
                </div>
                {isOpen && <div className="p-4 bg-slate-50 border-t border-slate-100 animate-fadeIn">{children}</div>}
            </div>
        );

        const Input = ({ label, fieldKey, val, setVal, type="text", placeholder="" }) => (
            <div className="mb-3">
                <div className="flex items-center mb-1">
                    <label className="text-[10px] uppercase font-bold text-slate-500">{label}</label>
                    {HELP_REGISTRY[fieldKey] && (
                        <div className="tooltip-container">
                            <span className="tooltip-icon">?</span>
                            <span className="tooltip-text">{HELP_REGISTRY[fieldKey]}</span>
                        </div>
                    )}
                </div>
                {type === 'textarea' ? 
                    <textarea className="w-full border border-slate-300 rounded p-2 text-sm bg-white focus:border-blue-500 outline-none transition-shadow focus:shadow-sm" rows="3" value={val} onChange={e=>setVal(e.target.value)} placeholder={placeholder} /> :
                    <input className="w-full border border-slate-300 rounded p-2 text-sm bg-white focus:border-blue-500 outline-none transition-shadow focus:shadow-sm" type={type} value={val} onChange={e=>setVal(e.target.value)} placeholder={placeholder} />
                }
            </div>
        );

        // --- DATA TAMBAHAN: SDGs ---
        const SDG_OPTIONS = [
            { code: "SDG 1", label: "No Poverty", color: "bg-red-500" },
            { code: "SDG 8", label: "Decent Work & Economy", color: "bg-red-700" },
            { code: "SDG 9", label: "Industry & Innovation", color: "bg-orange-500" },
            { code: "SDG 11", label: "Sustainable Cities", color: "bg-yellow-600" },
            { code: "SDG 12", label: "Responsible Consumption", color: "bg-yellow-700" },
            { code: "SDG 17", label: "Partnership for Goals", color: "bg-blue-800" }
        ];

        // --- MAIN APP ---
        const App = () => {
            const [activeSection, setActiveSection] = useState("general"); 
            
            // Core Data State
            const [regionName, setRegionName] = useState("");
            const [governance, setGovernance] = useState({ vision: "", timeline: "" });
            const [sectors, setSectors] = useState([]);
            // STATE BARU: Identitas Pejabat & Logo
            const [signer, setSigner] = useState({ name: "", title: "" });
            const [logo, setLogo] = useState(null); // Untuk menyimpan URL gambar logo
            
            // Fungsi untuk handle upload logo
            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const imageUrl = URL.createObjectURL(file);
                    setLogo(imageUrl);
                }
            };
            
            // Expanded Substance State
            const [swot, setSwot] = useState({ s: "", w: "", o: "", t: "" });
            const [stakeholders, setStakeholders] = useState([]);
            const [actionPlan, setActionPlan] = useState([]);
            
            // Legacy & UI State
            const [customModules, setCustomModules] = useState([]);
            const [customData, setCustomData] = useState({});
            const [apiKey, setApiKey] = useState("");
            const [aiAnalysis, setAiAnalysis] = useState("");
            const [aiLoading, setAiLoading] = useState(false);
            
            // Fungsi ini berguna untuk mengubah angka biasa (misal: 100) menjadi format uang ($100 M)
            const formatUSD = (val) => {
            if (!val) return "$0";
            return new Intl.NumberFormat('en-US', {
              style: 'currency',
              currency: 'USD',
              minimumFractionDigits: 0,
              maximumFractionDigits: 1
             }).format(val) + " M"; // Kita tambah 'M' untuk Million/Juta
        };
            const [showKeyModal, setShowKeyModal] = useState(false);

            // Refs
            const reportRef = useRef(null);
            const lqRef = useRef(null);
            const radarRef = useRef(null);
            const chartInstances = useRef({});

            // --- DATA HANDLERS SAMPLE DUMMY ---
            const loadSampleData = () => {
                // 1. General
                setRegionName("Kabupaten Flores Timur");
                setGovernance({ 
                    vision: "Menjadi sentra agro-industri berkelanjutan berbasis kearifan lokal yang berdaya saing global.", 
                    timeline: "2024-2029" 
                });
                
                // 2. Sectors (SDA & Culture)
                setSectors([
                   { 
                        id: 1, 
                        name: "Kopi Flores (Specialty)", 
                        localVal: 30,       // $30 Juta (sebelumnya 450 Miliar IDR)
                        nationalVal: 800,   // $800 Juta
                        workers: 5000, 
                        exportVal: 15,      // $15 Juta
                        rationale: "Indikator Geografis (IG) kuat, pasar premium global.",
                        tech: "Smart Farming (IoT) & Traceability Blockchain" // <--- Contoh Tech
                    },
                    { 
                        id: 2, 
                        name: "Tenun Ikat", 
                        localVal: 8,        // $8 Juta
                        nationalVal: 1500, 
                        workers: 2500, 
                        exportVal: 3,       // $3 Juta
                        rationale: "Warisan budaya tak benda, nilai tambah tinggi.",
                        tech: "Digital Archive Motif & E-Commerce Global" // <--- Contoh Tech
                    },
                    { 
                        id: 3, 
                        name: "Perikanan Tangkap", 
                        localVal: 800, nationalVal: 90000, workers: 8000, exportVal: 100, 
                        rationale: "Potensi laut luas, namun hilirisasi masih minim.",
                        tech: "Fish Finder (Sonar) & Cold Chain Management System" // <--- Contoh Tech
                    }
                ]);

                // 3. SWOT Analysis (Strategic)
                setSwot({
                    s: "1. Kualitas tanah vulkanik untuk pertanian.\n2. Tradisi tenun yang masih hidup di masyarakat.\n3. Posisi strategis jalur laut.",
                    w: "1. Infrastruktur pengolahan pasca panen minim.\n2. Akses permodalan perbankan rendah.\n3. Branding digital belum optimal.",
                    o: "1. Tren global 'Slow Fashion' & 'Organic Food'.\n2. Dukungan pemerintah pusat untuk Destinasi Super Prioritas (Labuan Bajo impact).",
                    t: "1. Perubahan iklim mengganggu panen.\n2. Persaingan dengan produk tekstil pabrikan murah."
                });

                // 4. Quadruple Helix (Collaboration)
                setStakeholders([
                    { id: 101, name: "Bappelitbangda", role: "Government", task: "Regulasi & Fasilitasi" },
                    { id: 102, name: "Univ. Nusa Cendana", role: "Academic", task: "Riset Varietas Kopi" },
                    { id: 103, name: "Koperasi Tani Mandiri", role: "Business", task: "Agregasi Produk" },
                    { id: 104, name: "Komunitas Adat", role: "Community", task: "Pelestarian Motif Tenun" }
                ]);

                // 5. Action Plan (Roadmap)
                setActionPlan([
                    { 
                        id: 201, 
                        activity: "Pembangunan Rumah Jemur Kopi", 
                        output: "5 Unit Green House", 
                        budget: "500 Juta", 
                        year: "2024",
                        sdg: "SDG 9" // <--- Industry & Innovation (Warna Oranye)
                    },
                    { 
                        id: 202, 
                        activity: "Festival Tenun Ikat Internasional", 
                        output: "1000 Pengunjung/Buyer", 
                        budget: "1 Milyar", 
                        year: "2025",
                        sdg: "SDG 11" // <--- Sustainable Cities/Communities (Warna Kuning)
                    },
                    { 
                        id: 203, 
                        activity: "Digitalisasi UMKM (Onboarding)", 
                        output: "50 UMKM Go Digital", 
                        budget: "200 Juta", 
                        year: "2024",
                        sdg: "SDG 8" // <--- Decent Work (Warna Merah)
                    }
                ]);

                alert("Sample Data Lengkap (SDG & Tech Ready) Telah Dimuat!");
            };

            const saveToJSON = () => {
                const data = { regionName, governance, sectors, swot, stakeholders, actionPlan, customModules, customData };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `S3_Strategy_${regionName.replace(/\s+/g,'_')}.json`;
                link.click();
            };

            const loadFromJSON = (e) => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        setRegionName(data.regionName || "");
                        setGovernance(data.governance || { vision: "", timeline: "" });
                        setSectors(data.sectors || []);
                        setSwot(data.swot || { s: "", w: "", o: "", t: "" });
                        setStakeholders(data.stakeholders || []);
                        setActionPlan(data.actionPlan || []);
                        setCustomModules(data.customModules || []);
                        setCustomData(data.customData || {});
                        alert("Data Loaded Successfully!");
                    } catch (err) { alert("Invalid JSON File"); }
                };
                if(e.target.files[0]) reader.readAsText(e.target.files[0]);
                e.target.value = null;
            };

            // --- CHART LOGIC ---
            const processedData = useMemo(() => {
                const totLoc = sectors.reduce((a,b)=>a+(b.localVal||0),0) || 1;
                const totNat = sectors.reduce((a,b)=>a+(b.nationalVal||0),0) || 1;
                const data = sectors.map(s => ({
                    ...s,
                    lq: parseFloat(((s.localVal/totLoc)/(s.nationalVal/totNat) || 0).toFixed(2))
                })).sort((a,b) => b.lq - a.lq);
                return { data };
            }, [sectors]);

            useEffect(() => {
                if(processedData.data.length === 0) return;
                // Update Charts logic similar to before, kept concise
                if(lqRef.current) {
                    if(chartInstances.current.lq) chartInstances.current.lq.destroy();
                    chartInstances.current.lq = new Chart(lqRef.current, {
                        type: 'bar',
                        data: {
                            labels: processedData.data.map(s => s.name),
                            datasets: [{ label: 'LQ Score', data: processedData.data.map(s => s.lq), backgroundColor: '#1e3a5f', borderRadius: 4 }]
                        },
                        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                    });
                }
                if(radarRef.current) {
                    if(chartInstances.current.radar) chartInstances.current.radar.destroy();
                    chartInstances.current.radar = new Chart(radarRef.current, {
                        type: 'radar',
                        data: {
                            labels: ['Jobs', 'Export', 'LQ Potential', 'Growth'],
                            datasets: processedData.data.slice(0,3).map((s,i) => ({
                                label: s.name,
                                data: [s.workers > 1000 ? 5:3, s.exportVal > 100 ? 5:2, s.lq > 1 ? 5:2, 4],
                                backgroundColor: i===0 ? 'rgba(30,58,95,0.2)' : 'rgba(224,122,95,0.2)',
                                borderColor: i===0 ? '#1e3a5f' : '#e07a5f'
                            }))
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { r: { min: 0, max: 6 } } }
                    });
                }
            }, [processedData]);

            const handleAI = async () => {
                if(!apiKey) return setShowKeyModal(true);
                setAiLoading(true);
                // Enhanced Prompt with new data
                const prompt = `Role: Senior Economic Strategist. 
                Context: S3 Strategy for ${regionName}.
                Vision: ${governance.vision}.
                SWOT Summary: S:${swot.s}, W:${swot.w}, O:${swot.o}, T:${swot.t}.
                Key Sectors: ${JSON.stringify(sectors.map(s=>s.name))}.
                Stakeholders: ${stakeholders.length} entities.
                Action Plan: ${actionPlan.length} items.
                
                Task: Create a cohesive Executive Summary (max 300 words). Integrate the Vision with the Sectors and SWOT. Use professional, persuasive language. Output in HTML format (<p>, <strong>, <ul>).`;
                
                try {
                    const res = await AI_BRIDGE.generate(prompt, apiKey);
                    setAiAnalysis(res);
                } catch (e) { alert("AI Error: " + e.message); } 
                finally { setAiLoading(false); }
            }
            // --- FUNGSI BARU: EXPORT TO WORD ---
            const exportToWord = () => {
                if (!reportRef.current) return;

                // 1. Kita clone (duplikat) dulu elemen report-nya agar tampilan asli tidak berubah
                const originalElement = reportRef.current;
                const clone = originalElement.cloneNode(true);

                // 2. Trik Sulap: Ubah semua Chart (Canvas) menjadi Gambar (Image)
                // Word tidak bisa baca <canvas>, jadi harus jadi <img>
                const originalCanvases = originalElement.querySelectorAll('canvas');
                const clonedCanvases = clone.querySelectorAll('canvas');

                clonedCanvases.forEach((clonedCanvas, index) => {
                    const originalCanvas = originalCanvases[index];
                    // Buat elemen gambar baru
                    const img = document.createElement('img');
                    // Ambil data gambar dari canvas asli
                    img.src = originalCanvas.toDataURL('image/png'); 
                    // Set ukuran agar rapi
                    img.style.width = '100%';
                    img.style.maxWidth = '100%';
                    
                    // Ganti canvas di clone dengan gambar
                    clonedCanvas.parentNode.replaceChild(img, clonedCanvas);
                });

                // 3. Persiapkan HTML untuk Word
                // Kita tambahkan sedikit style inline agar tabel ada garisnya di Word
                const htmlContent = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                    <head>
                        <meta charset='utf-8'>
                        <title>Export Document</title>
                        <style>
                            /* Sedikit style dasar agar tabel rapi di Word */
                            body { font-family: 'Arial', sans-serif; }
                            table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                            th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                            h1, h2, h3 { color: #1e3a5f; }
                            .no-print { display: none; } /* Sembunyikan tombol close di dalam konten */
                        </style>
                    </head>
                    <body>
                        ${clone.innerHTML}
                    </body>
                    </html>
                `;

                // 4. Bungkus jadi Blob (File Object)
                const blob = new Blob(['\ufeff', htmlContent], {
                    type: 'application/msword'
                });

                // 5. Download File
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `S3_Strategy_${regionName || 'Document'}.doc`; // Ekstensi .doc agar mudah dibuka
                document.body.appendChild(link);
                link.click();
                
                // Bersihkan memori
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            return (
                <div className="flex h-screen bg-slate-100 overflow-hidden text-slate-800 font-sans">
                    {/* MODALS */}
                    {showKeyModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                            <div className="bg-white p-6 rounded-xl shadow-2xl w-96 animate-fadeIn border border-slate-200">
                                <h3 className="font-bold text-lg mb-2 flex items-center gap-2">üîë AI Configuration</h3>
                                <p className="text-xs text-slate-500 mb-4">Paste your Gemini API Key to unlock AI Analysis features.</p>
                                <input type="password" placeholder="sk-..." className="w-full border p-2 rounded mb-4 text-sm font-mono bg-slate-50" value={apiKey} onChange={e=>setApiKey(e.target.value)} />
                                <div className="flex justify-end gap-2"><button onClick={()=>setShowKeyModal(false)} className="px-4 py-2 text-sm text-slate-500 hover:text-slate-800">Cancel</button><button onClick={()=>setShowKeyModal(false)} className="px-4 py-2 text-sm bg-navy-900 text-white rounded font-bold hover:bg-navy-700">Connect</button></div>
                            </div>
                        </div>
                    )}

                    {/* LEFT SIDEBAR (INPUTS) */}
                    {/* UBAH BARIS INI (Tambahkan print:hidden) */}
                    <div className="w-4/12 bg-white border-r flex flex-col z-10 shadow-xl print:hidden">
                        <div className="p-5 bg-navy-900 text-white flex justify-between items-center shrink-0">
                            <div><h1 className="font-bold tracking-widest text-lg">S3 BUILDER</h1><div className="text-[10px] opacity-70">Professional Edition</div></div>
                            <div className="flex gap-1">
                                <button onClick={()=>setShowKeyModal(true)} title="AI Settings" className={`p-2 rounded transition-colors ${apiKey ? 'text-green-400' : 'text-slate-400 hover:text-white'}`}>‚öôÔ∏è</button>
                                <button onClick={saveToJSON} title="Save" className="p-2 text-white hover:bg-white/10 rounded">üíæ</button>
                                <label title="Load" className="p-2 text-white hover:bg-white/10 rounded cursor-pointer">üìÇ<input type="file" onChange={loadFromJSON} className="hidden" accept=".json" /></label>
                            </div>
                        </div>
                        
                        <div className="bg-navy-800 px-5 py-2 flex justify-between items-center border-t border-navy-700">
                            <span className="text-[10px] text-slate-300">Quick Actions:</span>
                            <button onClick={loadSampleData} className="text-[10px] bg-terracotta-500 hover:bg-terracotta-600 text-white px-3 py-1 rounded font-bold shadow-sm transition-colors">Load Sample Data</button>
                        </div>

                        <div className="flex-1 overflow-y-auto custom-scrollbar">
                            {/* 1. GENERAL */}
                            <Accordion title="General Identity" icon="üèõÔ∏è" isOpen={activeSection === 'general'} onClick={() => setActiveSection(activeSection === 'general' ? '' : 'general')}>
                                <Input label="Region Name" fieldKey="regionName" val={regionName} setVal={setRegionName} placeholder="e.g. Kabupaten..." />
                                <Input label="Vision Statement" fieldKey="vision" type="textarea" val={governance.vision} setVal={v => setGovernance({...governance, vision: v})} placeholder="What is the big goal?" />
                                <Input label="Strategic Timeline" fieldKey="timeline" val={governance.timeline} setVal={v => setGovernance({...governance, timeline: v})} placeholder="e.g. 2024-2029" />
                                <div className="mt-4 pt-4 border-t border-slate-200">
                                    <label className="text-[9px] uppercase font-bold text-slate-400 mb-1 block">Logo Daerah/ Govt. Logo (PNG/JPG)</label>
                                    <input type="file" accept="image/*" onChange={handleLogoUpload} className="w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-3"/>
                                    
                                    <div className="grid grid-cols-2 gap-2">
                                        <Input label="Nama Pejabat (Ttd)" val={signer.name} setVal={v => setSigner({...signer, name: v})} placeholder="Bpk. Nama Pejabat" />
                                        <Input label="Jabatan" val={signer.title} setVal={v => setSigner({...signer, title: v})} placeholder="Bupati Flores Timur" />
                                    </div>
                                </div>

                               </Accordion>

                            {/* 2. SECTORS */}
                            <Accordion title="Priority Sectors" icon="üìä" isOpen={activeSection === 'sectors'} onClick={() => setActiveSection(activeSection === 'sectors' ? '' : 'sectors')}
                                extraAction={<button onClick={(e) => { e.stopPropagation(); setSectors([...sectors, {id: Date.now(), name: "New Sector", localVal:0}]); setActiveSection('sectors'); }} className="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded font-bold border border-green-200 hover:bg-green-200">+ Add</button>}>
                                {sectors.length === 0 && <p className="text-xs text-slate-400 italic text-center py-4">No sectors defined. Add one to start analysis.</p>}
                                {sectors.map((s, idx) => (
                                    <div key={s.id} className="mb-4 p-3 border border-slate-200 rounded bg-slate-50 relative group">
                                        <button onClick={()=>setSectors(sectors.filter(x=>x.id!==s.id))} className="absolute top-2 right-2 text-slate-300 hover:text-red-500 font-bold transition-colors">√ó</button>
                                        <div className="font-bold text-[9px] text-navy-700 mb-2 uppercase tracking-widest bg-slate-200 inline-block px-1 rounded">Sector {idx+1}</div>
                                        <Input label="Sector Name" val={s.name} setVal={v => {const n=[...sectors]; n[idx].name=v; setSectors(n)}} />
                                        <div className="grid grid-cols-2 gap-2">
                                            {SECTOR_CONFIG.map(cfg => (
                                                <div key={cfg.key}>
                                                    <label className="text-[9px] uppercase font-bold text-slate-400">{cfg.label}</label>
                                                    <div className="flex items-center">
                                                        <input type="number" className="w-full border border-slate-300 rounded p-1 text-sm bg-white focus:border-blue-500 outline-none" value={s[cfg.key]||0} onChange={e=>{const n=[...sectors]; n[idx][cfg.key]=parseFloat(e.target.value); setSectors(n)}} />
                                                        {HELP_REGISTRY[cfg.key] && <div className="tooltip-container"><span className="tooltip-icon w-3 h-3 text-[8px]">?</span><span className="tooltip-text">{HELP_REGISTRY[cfg.key]}</span></div>}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        {/* --- UPDATE: RATIONALE & TECH FOCUS --- */}
                                            <div className="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                                                <div>
                                                    <label className="text-[9px] uppercase font-bold text-slate-400">Strategic Rationale</label>
                                                    <textarea className="w-full border border-slate-300 rounded p-1 text-sm bg-white focus:border-blue-500 outline-none" rows="3" value={s.rationale||""} onChange={e=>{const n=[...sectors]; n[idx].rationale=e.target.value; setSectors(n)}} placeholder="Kenapa sektor ini dipilih?"></textarea>
                                                </div>
                                                <div>
                                                    <label className="text-[9px] uppercase font-bold text-blue-500">Technology & Innovation Focus (IT/R&D)</label>
                                                    <textarea className="w-full border border-blue-200 bg-blue-50 rounded p-1 text-sm focus:border-blue-500 outline-none" rows="3" value={s.tech||""} onChange={e=>{const n=[...sectors]; n[idx].tech=e.target.value; setSectors(n)}} placeholder="Contoh: IoT untuk monitoring panen, E-Commerce, Blockchain traceability..."></textarea>
                                                </div>
                                            </div>
                                    </div>
                                ))}
                            </Accordion>

                            {/* 3. SWOT ANALYSIS (NEW) */}
                            <Accordion title="SWOT Analysis" icon="üõ°Ô∏è" isOpen={activeSection === 'swot'} onClick={() => setActiveSection(activeSection === 'swot' ? '' : 'swot')}>
                                <Input label="Strengths (Internal)" fieldKey="strength" type="textarea" val={swot.s} setVal={v => setSwot({...swot, s: v})} placeholder="List strengths..." />
                                <Input label="Weaknesses (Internal)" fieldKey="weakness" type="textarea" val={swot.w} setVal={v => setSwot({...swot, w: v})} placeholder="List weaknesses..." />
                                <div className="my-2 border-t border-slate-200"></div>
                                <Input label="Opportunities (External)" fieldKey="opportunity" type="textarea" val={swot.o} setVal={v => setSwot({...swot, o: v})} placeholder="List opportunities..." />
                                <Input label="Threats (External)" fieldKey="threat" type="textarea" val={swot.t} setVal={v => setSwot({...swot, t: v})} placeholder="List threats..." />
                            </Accordion>

                            {/* 4. QUADRUPLE HELIX (NEW) */}
                            <Accordion title="Stakeholders (Helix)" icon="ü§ù" isOpen={activeSection === 'helix'} onClick={() => setActiveSection(activeSection === 'helix' ? '' : 'helix')}
                                extraAction={<button onClick={(e) => { e.stopPropagation(); setStakeholders([...stakeholders, {id: Date.now(), name: "", role: "Government"}]); setActiveSection('helix'); }} className="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold border border-blue-200 hover:bg-blue-200">+ Add</button>}>
                                {stakeholders.map((st, idx) => (
                                    <div key={st.id} className="mb-2 p-2 border border-slate-200 rounded flex gap-2 items-start bg-slate-50">
                                        <div className="flex-1">
                                            <input className="w-full border-b bg-transparent text-sm font-bold mb-1 focus:outline-none focus:border-blue-500" placeholder="Organization Name" value={st.name} onChange={e=>{const n=[...stakeholders]; n[idx].name=e.target.value; setStakeholders(n)}} />
                                            <div className="flex gap-2">
                                                <select className="text-xs border rounded p-1 w-1/2" value={st.role} onChange={e=>{const n=[...stakeholders]; n[idx].role=e.target.value; setStakeholders(n)}}>
                                                    <option value="Government">Government</option>
                                                    <option value="Academic">Academic</option>
                                                    <option value="Business">Business</option>
                                                    <option value="Community">Community</option>
                                                </select>
                                                <input className="text-xs border rounded p-1 w-1/2" placeholder="Key Task..." value={st.task||""} onChange={e=>{const n=[...stakeholders]; n[idx].task=e.target.value; setStakeholders(n)}} />
                                            </div>
                                        </div>
                                        <button onClick={()=>setStakeholders(stakeholders.filter(x=>x.id!==st.id))} className="text-slate-400 hover:text-red-500 font-bold px-1">√ó</button>
                                    </div>
                                ))}
                            </Accordion>

                            {/* 5. ACTION PLAN (NEW) */}
                            <Accordion title="Action Plan" icon="üöÄ" isOpen={activeSection === 'action'} onClick={() => setActiveSection(activeSection === 'action' ? '' : 'action')}
                                extraAction={<button onClick={(e) => { e.stopPropagation(); setActionPlan([...actionPlan, {id: Date.now(), activity: "", year: "2024"}]); setActiveSection('action'); }} className="text-[10px] bg-purple-100 text-purple-700 px-2 py-1 rounded font-bold border border-purple-200 hover:bg-purple-200">+ Add</button>}>
                                {actionPlan.map((act, idx) => (
                                    <div key={act.id} className="mb-3 p-3 border border-slate-200 rounded bg-slate-50 relative">
                                        <button onClick={()=>setActionPlan(actionPlan.filter(x=>x.id!==act.id))} className="absolute top-1 right-2 text-slate-300 hover:text-red-500 font-bold">√ó</button>
                                        <Input label="Activity Name" fieldKey="actionActivity" val={act.activity} setVal={v=>{const n=[...actionPlan]; n[idx].activity=v; setActionPlan(n)}} />
                                        <div className="flex gap-2 mb-2">
                                                        <div className="w-1/4">
                                                            <label className="text-[9px] font-bold text-slate-400 uppercase">Year</label>
                                                            <input className="w-full border p-1 rounded text-xs" value={act.year||""} onChange={e=>{const n=[...actionPlan]; n[idx].year=e.target.value; setActionPlan(n)}} />
                                                        </div>
                                                        <div className="flex-1">
                                                            <label className="text-[9px] font-bold text-slate-400 uppercase">SDG Alignment</label>
                                                            <select className="w-full border p-1 rounded text-xs bg-white" value={act.sdg||""} onChange={e=>{const n=[...actionPlan]; n[idx].sdg=e.target.value; setActionPlan(n)}}>
                                                                <option value="">- Select Goal -</option>
                                                                {SDG_OPTIONS.map(opt => (
                                                                    <option key={opt.code} value={opt.code}>{opt.code} - {opt.label}</option>
                                                                ))}
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="text-[9px] font-bold text-slate-400 uppercase">Target/Output</label>
                                                        <input className="w-full border p-1 rounded text-xs" value={act.output||""} onChange={e=>{const n=[...actionPlan]; n[idx].output=e.target.value; setActionPlan(n)}} />
                                                    </div>
                                    </div>
                                ))}
                            </Accordion>

                        </div>
                    </div>

                    {/* RIGHT PREVIEW (REPORT) */}
                    {/* UBAH BARIS INI (Tambahkan print:w-full print:overflow-visible print:absolute print:top-0 print:left-0) */}
                    <div className="w-8/12 bg-slate-200/50 p-8 overflow-y-auto relative print:w-full print:overflow-visible print:absolute print:top-0 print:left-0 print:bg-white print:p-0">
                        <div className="absolute top-4 right-8 flex gap-2 no-print z-20">
                            {/* Tombol AI */}
                            <button onClick={handleAI} disabled={aiLoading} className={`px-4 py-2 rounded-full text-white text-xs font-bold shadow-lg flex items-center gap-2 ${aiLoading ? 'bg-slate-400' : 'bg-gradient-to-r from-blue-600 to-indigo-600 hover:shadow-xl transition-all'}`}>
                                <span>‚ú®</span> {aiLoading ? 'Analyzing...' : 'AI Exec Summary'}
                            </button>
                            
                            {/* Tombol Save DOC */}
                            <button onClick={exportToWord} className="bg-blue-800 text-white px-4 py-2 rounded shadow text-xs font-bold hover:bg-blue-700 transition-colors flex items-center gap-1">
                                <span>üìÑ</span> Save DOC
                            </button>

                            {/* Tombol Print PDF */}
                            <button onClick={() => window.print()} className="bg-navy-900 text-white px-4 py-2 rounded shadow text-xs font-bold hover:bg-navy-800 transition-colors">
                                Print PDF
                            </button>
                        </div>

                        <div ref={reportRef} className="report-paper max-w-5xl mx-auto p-12 text-slate-800 relative animate-fadeIn">
                            
                            {/* COVER HEADER */}
                            <div className="mb-10 border-b-4 border-navy-900 pb-6 flex justify-between items-end">
                                {/* Container Kiri: Gabungan Logo & Judul */}
                                <div className="flex items-start gap-6">
                                    
                                    {/* 1. LOGO (Hanya muncul jika ada) */}
                                    {logo && (
                                        <img src={logo} alt="Logo Daerah" className="h-24 w-auto object-contain" />
                                    )}

                                    {/* 2. JUDUL TEKS */}
                                    <div>
                                        {/* Badge Tipe Dokumen */}
                                        <span className="bg-terracotta-500 text-white px-2 py-1 text-[10px] font-bold uppercase tracking-widest rounded mb-2 inline-block">S3 Strategy Document</span>
                                        
                                        {/* Nama Daerah */}
                                        <h1 className="font-serif text-5xl font-bold text-navy-900 mt-2 leading-tight">{regionName || "Untitled Region"}</h1>
                                        
                                        {/* Sub-judul */}
                                        <div className="mt-4 text-sm text-slate-500 font-medium">Smart Specialization Strategy Roadmap ‚Ä¢ {governance.timeline || "Draft Period"}</div>
                                    </div>
                                </div>

                                {/* Container Kanan: Tahun (Tetap) */}
                                <div className="text-right hidden sm:block">
                                    <div className="text-4xl font-bold text-slate-200">2024</div>
                                </div>
                            </div>
                            
                            {/* AI ANALYSIS BLOCK */}
                            {aiAnalysis && (
                                <div className="mb-10 bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-100 p-8 rounded-xl relative shadow-sm">
                                    <h4 className="text-xs font-bold text-blue-600 uppercase mb-4 flex items-center gap-2"><span className="text-lg">‚ú®</span> Executive Summary (AI Generated)</h4>
                                    <div className="prose prose-sm max-w-none text-slate-700 font-serif leading-relaxed" dangerouslySetInnerHTML={{__html: aiAnalysis}}></div>
                                    <button onClick={()=>setAiAnalysis("")} className="absolute top-4 right-4 text-slate-400 hover:text-red-500 no-print">‚úï</button>
                                </div>
                            )}

                            {/* VISION */}
                            {governance.vision && (
                                <div className="mb-12 text-center px-10">
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Strategic Vision</h4>
                                    <p className="font-serif text-2xl text-navy-800 italic leading-relaxed">"{governance.vision}"</p>
                                </div>
                            )}
                            
                            {/* SECTORS & CHARTS */}
                            {sectors.length > 0 && (
                                <div className="mb-12 page-break">
                                    <h3 className="section-title text-xl font-bold text-navy-900 mb-6 flex items-center gap-3"><span className="w-8 h-1 bg-terracotta-500 block"></span>Priority Sectors & Analysis</h3>
                                    
                                    <div className="grid grid-cols-2 gap-8 mb-8 page-break-avoid">
                                        <div className="bg-white border rounded-lg p-4 shadow-sm">
                                            <h4 className="text-xs font-bold text-center mb-2">Location Quotient (LQ)</h4>
                                            <div className="h-56"><canvas ref={lqRef}></canvas></div>
                                        </div>
                                        <div className="bg-white border rounded-lg p-4 shadow-sm">
                                            <h4 className="text-xs font-bold text-center mb-2">Sector Potential Radar</h4>
                                            <div className="h-56"><canvas ref={radarRef}></canvas></div>
                                        </div>
                                    </div>

                                    <div className="overflow-x-auto page-break-avoid">
                                        <table className="w-full text-sm text-left border rounded-lg overflow-hidden">
                                            <thead className="bg-navy-900 text-white uppercase text-xs">
                                                <tr>
                                                    <th className="p-3">Sector Name</th>
                                                    <th className="p-3 text-right">LQ Score</th>
                                                    <th className="p-3 text-right">Export</th>
                                                    <th className="p-3">Strategic Rationale</th>
                                                    <th className="p-3 bg-blue-900 text-blue-100">Tech Focus</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100 border">
                                                {processedData.data.map(s => (
                                                    <tr key={s.id} className="hover:bg-slate-50">
                                                        <td className="p-3 font-bold text-navy-800">{s.name}</td>
                                                        <td className="p-3 text-right font-mono text-xs">{s.lq}</td>
                                                        <td className="p-3 text-right font-mono text-xs text-green-700 font-bold">{formatUSD(s.exportVal)}</td>
                                                        <td className="p-3 text-slate-600 text-xs italic">{s.rationale}</td>
                                                        <td className="p-3 text-blue-800 text-xs font-medium bg-blue-50">{s.tech || "-"}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {/* SWOT MATRIX */}
                            {(swot.s || swot.w || swot.o || swot.t) && (
                                <div className="mb-12 page-break">
                                    <h3 className="section-title text-xl font-bold text-navy-900 mb-6 flex items-center gap-3"><span className="w-8 h-1 bg-terracotta-500 block"></span>SWOT Analysis</h3>
                                    <div className="grid grid-cols-2 gap-4 page-break-avoid">
                                        <div className="p-5 bg-blue-50 border border-blue-100 rounded-lg">
                                            <h4 className="font-bold text-blue-800 mb-2 uppercase text-xs">Strengths</h4>
                                            <p className="whitespace-pre-line text-sm text-slate-700">{swot.s || "-"}</p>
                                        </div>
                                        <div className="p-5 bg-orange-50 border border-orange-100 rounded-lg">
                                            <h4 className="font-bold text-orange-800 mb-2 uppercase text-xs">Weaknesses</h4>
                                            <p className="whitespace-pre-line text-sm text-slate-700">{swot.w || "-"}</p>
                                        </div>
                                        <div className="p-5 bg-green-50 border border-green-100 rounded-lg">
                                            <h4 className="font-bold text-green-800 mb-2 uppercase text-xs">Opportunities</h4>
                                            <p className="whitespace-pre-line text-sm text-slate-700">{swot.o || "-"}</p>
                                        </div>
                                        <div className="p-5 bg-red-50 border border-red-100 rounded-lg">
                                            <h4 className="font-bold text-red-800 mb-2 uppercase text-xs">Threats</h4>
                                            <p className="whitespace-pre-line text-sm text-slate-700">{swot.t || "-"}</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* STAKEHOLDERS & ACTION PLAN GRID */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12 page-break">
                                {/* Stakeholders */}
                                {stakeholders.length > 0 && (
                                    <div>
                                        <h3 className="section-title text-lg font-bold text-navy-900 mb-4 flex items-center gap-2"><span className="w-4 h-1 bg-terracotta-500 block"></span>Helix Actors</h3>
                                        <ul className="space-y-3">
                                            {stakeholders.map(st => (
                                                <li key={st.id} className="bg-white border p-3 rounded shadow-sm flex items-center gap-3">
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold
                                                        ${st.role === 'Government' ? 'bg-navy-700' : st.role === 'Academic' ? 'bg-purple-600' : st.role === 'Business' ? 'bg-emerald-600' : 'bg-orange-500'}`}>
                                                        {st.role[0]}
                                                    </div>
                                                    <div>
                                                        <div className="font-bold text-sm text-navy-800">{st.name}</div>
                                                        <div className="text-xs text-slate-500">{st.role} ‚Ä¢ {st.task}</div>
                                                    </div>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}

                                {/* Action Plan */}
                                {actionPlan.length > 0 && (
                                    <div>
                                        <h3 className="section-title text-lg font-bold text-navy-900 mb-4 flex items-center gap-2"><span className="w-4 h-1 bg-terracotta-500 block"></span>Strategic Roadmap</h3>
                                        <div className="relative border-l-2 border-slate-200 ml-3 space-y-6 pl-6 py-2">
                                            {actionPlan.sort((a,b)=>a.year - b.year).map(act => 
                                                /* --- UPDATE: TAMPILAN ROADMAP DENGAN SDG --- */
                                                (
                                                <div key={act.id} className="relative pl-6 pb-6 border-l-2 border-slate-200 last:border-0 last:pb-0">
                                                                <span className="absolute -left-[5px] top-1 w-2 h-2 rounded-full bg-terracotta-500 ring-4 ring-white"></span>
                                                                
                                                                <div className="flex justify-between items-start">
                                                                    <div>
                                                                        <div className="flex items-center gap-2 mb-1">
                                                                            <span className="text-xs font-bold text-terracotta-600 bg-terracotta-50 px-2 py-0.5 rounded">{act.year}</span>
                                                                            
                                                                            {act.sdg && (
                                                                                <span className={`text-[9px] text-white px-2 py-0.5 rounded-full font-bold uppercase ${SDG_OPTIONS.find(o=>o.code===act.sdg)?.color || 'bg-slate-500'}`}>
                                                                                    {act.sdg}
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                        <h4 className="font-bold text-sm text-navy-800 leading-tight">{act.activity}</h4>
                                                                        <div className="text-xs text-slate-500 mt-1 italic">Output: {act.output}</div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            {(signer.name || signer.title) && (
                                <div className="mt-20 flex justify-end page-break-avoid">
                                    <div className="text-center w-64">
                                        <div className="text-sm font-medium text-slate-500 mb-16">Disahkan di {regionName ? regionName.split(" ").pop() : "Tempat"}, {new Date().getFullYear()}</div>
                                        <div className="font-bold text-navy-900 border-b border-navy-900 pb-1 mb-1">{signer.name || "Nama Pejabat"}</div>
                                        <div className="text-xs uppercase tracking-widest text-slate-500">{signer.title || "Jabatan"}</div>
                                    </div>
                                </div>
                            )}

                            <div className="mt-16 pt-6 border-t flex justify-between text-[10px] text-slate-400 uppercase tracking-widest">
                                <span>S3 Builder Professional</span>
                                <span>Generated: {new Date().toLocaleDateString()}</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
